name: Test

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  lint:
    name: Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm install
      
      - name: Run ESLint
        run: npm run lint:js
        continue-on-error: true
      
      - name: Run Stylelint
        run: npm run lint:css
        continue-on-error: true
      
      - name: Run HTML validation
        run: npm run lint:html
        continue-on-error: true
      
      - name: Run JSON validation
        run: npm run lint:json
      
      - name: Check required files
        run: |
          for file in src/index.html src/index.mobile.html src/tr-web-control/config.js src/tr-web-control/plugin.js; do
            if [ ! -f "$file" ]; then
              echo "Error: Missing required file: $file"
              exit 1
            fi
          done

  shellcheck:
    name: Shell Script Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Shellcheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: 'release'
          format: gcc

  integration:
    name: OpenWRT Integration Test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # x86_64 - 3 major OpenWRT versions
          - arch: 'x86_64'
            openwrt-version: '22.03.7'
            memory-limit: ''
          - arch: 'x86_64'
            openwrt-version: '23.05.5'
            memory-limit: ''
          - arch: 'x86_64-openwrt'
            openwrt-version: '24.10'
            memory-limit: ''
          # ARM64 for mediatek/filogic - Target: Routerich AX3000
          # Device specs: MT7981BA (ARMv8), 256 MB RAM, OpenWrt 24.10
          # Note: ARM64 images use different tag format (no version suffix)
          - arch: 'armsr-armv8'
            openwrt-version: 'SNAPSHOT'
            memory-limit: '256m'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Set up QEMU for ARM64
        if: contains(matrix.arch, 'arm')
        uses: docker/setup-qemu-action@v3
      
      - name: Pull OpenWRT image
        run: |
          IMAGE_TAG="${ARCH}-${OPENWRT_VERSION}"
          echo "Pulling image: ghcr.io/openwrt/rootfs:${IMAGE_TAG}"
          
          # ARM64 SNAPSHOT uses non-standard arch "aarch64_generic", need to pull by digest
          if [[ "$ARCH" == "armsr-armv8" && "$OPENWRT_VERSION" == "SNAPSHOT" ]]; then
            echo "ARM64 SNAPSHOT: pulling by manifest digest..."
            # Get the aarch64_generic manifest digest
            DIGEST=$(docker manifest inspect ghcr.io/openwrt/rootfs:${IMAGE_TAG} 2>/dev/null | \
              jq -r '.manifests[] | select(.platform.architecture == "aarch64_generic") | .digest' || echo "")
            if [ -n "$DIGEST" ]; then
              docker pull ghcr.io/openwrt/rootfs@${DIGEST}
              docker tag ghcr.io/openwrt/rootfs@${DIGEST} ghcr.io/openwrt/rootfs:${IMAGE_TAG}
            else
              echo "Failed to get digest, trying direct pull..."
              docker pull ghcr.io/openwrt/rootfs:${IMAGE_TAG} || exit 1
            fi
          else
            docker pull ghcr.io/openwrt/rootfs:${IMAGE_TAG}
          fi
        env:
          ARCH: ${{ matrix.arch }}
          OPENWRT_VERSION: ${{ matrix.openwrt-version }}
      
      - name: Run integration test
        run: |
          MEMORY_OPTS=""
          if [ -n "$MEMORY_LIMIT" ]; then
            MEMORY_OPTS="--memory=$MEMORY_LIMIT --memory-swap=$MEMORY_LIMIT"
            echo "Memory limit: $MEMORY_LIMIT (simulating Routerich AX3000)"
          fi
          
          IMAGE_TAG="${ARCH}-${OPENWRT_VERSION}"
          echo "Running tests with image: ghcr.io/openwrt/rootfs:${IMAGE_TAG}"
          
          docker run --rm \
            --privileged \
            $MEMORY_OPTS \
            -v ${{ github.workspace }}/src:/tmp/webui:ro \
            ghcr.io/openwrt/rootfs:${IMAGE_TAG} \
            /bin/sh -c "
              /sbin/init &
              sleep 10
              
              # Install packages (APK for SNAPSHOT, opkg for stable)
              if command -v apk >/dev/null 2>&1; then
                echo 'Using APK package manager (SNAPSHOT)'
                apk update
                apk add transmission-daemon transmission-web
              elif command -v opkg >/dev/null 2>&1; then
                echo 'Using opkg package manager'
                opkg update
                opkg install transmission-daemon transmission-web
              else
                echo 'No package manager found'
                exit 1
              fi
              
              # Copy web interface
              mkdir -p /usr/share/transmission/web
              cp -r /tmp/webui/* /usr/share/transmission/web/
              chmod -R 755 /usr/share/transmission/web
              
              # Configure and start Transmission
              mkdir -p /etc/transmission /var/lib/transmission/downloads
              echo '{\"download-dir\":\"/var/lib/transmission/downloads\",\"rpc-enabled\":true,\"rpc-bind-address\":\"0.0.0.0\",\"rpc-port\":9091,\"rpc-whitelist-enabled\":false,\"rpc-authentication-required\":false}' > /etc/transmission/settings.json
              export TRANSMISSION_WEB_HOME=/usr/share/transmission/web
              transmission-daemon -g /etc/transmission
              sleep 3
              
              # Verify
              echo 'Checking Transmission daemon...'
              pgrep -f transmission-daemon || { echo 'Transmission not running'; exit 1; }
              echo 'Transmission daemon is running'
              
              echo 'Checking web interface...'
              wget -q -O - http://localhost:9091/transmission/web/ | grep -q 'Transmission' || { echo 'Web interface not accessible'; exit 1; }
              echo 'Web interface is accessible'
              
              echo 'Checking required files...'
              test -f /usr/share/transmission/web/index.html || { echo 'Missing index.html'; exit 1; }
              test -f /usr/share/transmission/web/tr-web-control/config.js || { echo 'Missing config.js'; exit 1; }
              echo 'All required files present'
              
              echo ''
              echo 'All integration tests passed!'
            "
        env:
          ARCH: ${{ matrix.arch }}
          OPENWRT_VERSION: ${{ matrix.openwrt-version }}
          MEMORY_LIMIT: ${{ matrix.memory-limit }}

  functional:
    name: Functional Tests
    runs-on: ubuntu-latest
    needs: [lint, shellcheck]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm install
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
      
      - name: Start OpenWRT test environment
        run: |
          docker compose -f docker-compose.test.yml up -d openwrt-test
          sleep 30
      
      - name: Run functional tests
        run: npm run test:functional
        env:
          TEST_URL: http://localhost:9091
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
      
      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down
