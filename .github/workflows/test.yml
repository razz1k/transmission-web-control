name: Test

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  lint:
    name: Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint:js
        continue-on-error: true
      
      - name: Run Stylelint
        run: npm run lint:css
        continue-on-error: true
      
      - name: Run HTML validation
        run: npm run lint:html
        continue-on-error: true
      
      - name: Run JSON validation
        run: npm run lint:json
      
      - name: Check required files
        run: |
          for file in src/index.html src/index.mobile.html src/tr-web-control/config.js src/tr-web-control/plugin.js; do
            if [ ! -f "$file" ]; then
              echo "Error: Missing required file: $file"
              exit 1
            fi
          done

  shellcheck:
    name: Shell Script Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Shellcheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: 'release'
          format: gcc

  integration:
    name: OpenWRT Integration Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        openwrt-version: ['22.03.3', '23.05.0']
        arch: ['x86-64']
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Pull OpenWRT image
        run: |
          docker pull openwrt/rootfs:${ARCH}-openwrt-${OPENWRT_VERSION}
        env:
          ARCH: ${{ matrix.arch }}
          OPENWRT_VERSION: ${{ matrix.openwrt-version }}
      
      - name: Run integration test
        run: |
          docker run --rm \
            --privileged \
            -v ${{ github.workspace }}/src:/tmp/webui:ro \
            -v ${{ github.workspace }}/tests/integration/openwrt-test.sh:/tmp/test.sh:ro \
            openwrt/rootfs:${ARCH}-openwrt-${OPENWRT_VERSION} \
            /bin/sh -c "
              /sbin/init &
              sleep 10 &&
              chmod +x /tmp/test.sh &&
              /tmp/test.sh
            "
        env:
          ARCH: ${{ matrix.arch }}
          OPENWRT_VERSION: ${{ matrix.openwrt-version }}

  functional:
    name: Functional Tests
    runs-on: ubuntu-latest
    needs: [lint, shellcheck]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
      
      - name: Start OpenWRT test environment
        run: |
          docker-compose -f docker-compose.test.yml up -d openwrt-test
          sleep 30
      
      - name: Run functional tests
        run: npm run test:functional
        env:
          TEST_URL: http://localhost:9091
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
      
      - name: Cleanup
        if: always()
        run: docker-compose -f docker-compose.test.yml down
