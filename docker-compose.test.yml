version: '3.8'

services:
  # Development environment with SSH access
  openwrt-dev:
    image: openwrt/rootfs:x86-64-openwrt-23.05.0
    container_name: transmission-web-control-dev
    privileged: true
    ports:
      - "9091:9091"
      - "2222:22"
    volumes:
      - ./src:/tmp/webui
      - ./tests/integration/openwrt-test.sh:/tmp/test.sh:ro
    command: /bin/sh -c "
      /sbin/init &
      sleep 5 &&
      opkg update &&
      opkg install bash dropbear transmission-daemon transmission-web &&
      mkdir -p /usr/share/transmission/web &&
      cp -r /tmp/webui/* /usr/share/transmission/web/ &&
      chmod -R 755 /usr/share/transmission/web &&
      echo 'root:root' | chpasswd &&
      /etc/init.d/dropbear start &&
      /etc/init.d/transmission start &&
      echo 'SSH ready on port 2222 (user: root, password: root)' &&
      echo 'Transmission ready on port 9091' &&
      tail -f /dev/null
    "
    environment:
      - OPENWRT_VERSION=23.05.0
    networks:
      - test-network
    profiles:
      - dev

  # Test environment (CI mode)
  openwrt-test:
    image: openwrt/rootfs:x86-64-openwrt-23.05.0
    container_name: transmission-web-control-test
    privileged: true
    ports:
      - "9091:9091"
    volumes:
      - ./src:/tmp/webui:ro
      - ./tests/integration/openwrt-test.sh:/tmp/test.sh:ro
    command: /bin/sh -c "
      /sbin/init &
      sleep 10 &&
      chmod +x /tmp/test.sh &&
      /tmp/test.sh
    "
    environment:
      - OPENWRT_VERSION=23.05.0
    networks:
      - test-network

  playwright-test:
    image: mcr.microsoft.com/playwright:v1.40.0-focal
    container_name: transmission-playwright-test
    depends_on:
      - openwrt-test
    volumes:
      - .:/workspace
    working_dir: /workspace
    environment:
      - TEST_URL=http://openwrt-test:9091
      - CI=true
    command: sh -c "
      npm install &&
      npx playwright install --with-deps &&
      npm run test:functional
    "
    networks:
      - test-network

networks:
  test-network:
    driver: bridge
